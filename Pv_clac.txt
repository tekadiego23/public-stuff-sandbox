import numpy as np

def _as_dict(x):
    """Convertit la valeur renvoyée par le service en dict."""
    if isinstance(x, dict):
        return x
    if x in ("", None):
        return {}
    try:
        return eval(x)
    except Exception:
        return {}

def get_task_pl_calc_time_from_pv_stat_response(pv_stat_id, rest_response):
    # 1) tentative via la clé exacte
    raw = rest_response.get(pv_stat_id, None)
    d = _as_dict(raw)
    if d:
        return d.get("taskPLCalcTime", np.nan)

    # 2) fallback : chercher par numéro d’instrument (après "#sophis")
    instrument_id = None
    if pv_stat_id:
        parts = str(pv_stat_id).split("#sophis#")
        if len(parts) > 1:
            instrument_id = parts[1].split("#", 1)[0]  # valeur après #sophis

    if instrument_id:
        needle = f"#sophis#{instrument_id}#"
        for k, v in rest_response.items():  # "premier" trouvé
            if needle in str(k):
                d = _as_dict(v)
                if d:
                    return d.get("taskPLCalcTime", np.nan)

    # 3) rien trouvé
    return np.nan
